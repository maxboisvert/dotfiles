#!/bin/bash

set -ex

PROFILE=$1

LINE_INFO=`mvn validate | grep Building`
NAME=`python -c "print '$LINE_INFO'.split()[2]"`
VERSION=`python -c "print '$LINE_INFO'.split()[3]"`

mvn clean package -P $PROFILE -D skipTests
JAR_NAME=`basename $(ls target/*war-exec.jar)`

EXECJARS_DIR=target/execjars
WORK_DIR=$EXECJARS_DIR/$NAME/$VERSION

echo "Build info : $LINE_INFO $PROFILE"
echo "Extraction result - Name:$NAME Version:$VERSION"

mkdir -p $WORK_DIR

cp target/$JAR_NAME $WORK_DIR

cd $EXECJARS_DIR/$NAME
ln -s $VERSION current

cd $VERSION
ln -s $JAR_NAME current.jar

# scp ...

# cd execjars/$NAME/current
# java -jar current.jar -httpPort=8080

